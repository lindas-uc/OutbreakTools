<!doctype html>
<html lang="en">
<head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.6.0/css/ol.css" type="text/css">
    <style>
        .map {
            height: 400px;
            width: 100%;
        }
    </style>
    <script src="http://openlayers.org/en/v3.6.0/build/ol.js" type="text/javascript"></script>
    <script src="http://api3.geo.admin.ch/loader.js?lang=en" type="text/javascript"></script>
    <script src="http://d3js.org/d3.v2.min.js?2.9.3"></script>


    <title>OpenLayers 3 example</title>
</head>
<body>
<h2>My Map</h2>
<div id="map" class="map"></div>
<script type="text/javascript">
    var layer = ga.layer.create('ch.swisstopo.pixelkarte-farbe');
    var map = new ga.Map({
        target: 'map',
        layers: [layer],
        view: new ol.View({
            resolution: 550,
            center: [600670, 199655]
        })
    });

    //create vector layer
    var overlay = new ol.layer.Vector("movements");
    map.addLayer(overlay);

    d3.csv("testdata/testdata3.csv", function (data) {

        var div = d3.selectAll("#map");
        div.selectAll("svg").remove();
        var svg = div.append("svg");
        var g = svg.append("g");

        var mapSize = map.getSize();

        //extent: coordinates of map box. [west,south, east, north]
        var extent = map.getView().calculateExtent(mapSize);

        var positionOfBern = [600670,199655];

        var x = mapSize[0]/(extent[2]-extent[0])*(positionOfBern[0]-extent[0]);
        var y = mapSize[1] - mapSize[1]/(extent[3]-extent[1])*(positionOfBern[1]-extent[1]);

        svg.attr("width", mapSize[0])
                .attr("height", mapSize[1])
                .style("position","relative")
                .style("bottom", mapSize[1]);

        svg.append("circle").attr("r",20).attr("cx", x).attr("cy",y);

        console.log("size: " + mapSize[0] + "," + mapSize[1]);
        console.log(extent);
        console.log(x);
        console.log(y);

        var feature = g.selectAll("path")
                .data(data)
                .enter().append("circle")
                .on("mouseover", function (d) {
                    var mousePosition = d3.svg.mouse(this);
                    var format = d3.time.format("%Y-%m-%d %HH:%MM:%SS");
                    $("#pop-up").fadeOut(100, function () {
                        // Popup content
                        $("#pop-up-title").html(format(new Date(parseInt(d.properties.time))));
                        $("#pop-img").html(d.properties.mag);
                        $("#pop-desc").html(d.properties.place);

                        // Popup position
                        var popLeft = mousePosition[0] + 300 > screen.width ?
                        mousePosition[0] - 400 : mousePosition[0];
                        var popTop = mousePosition[1];
                        $("#pop-up").css({
                            "left": popLeft + 50,
                            "top": popTop
                        });
                        $("#pop-up").fadeIn(100);
                    });
                }).on("mouseout", function () {
                    $("#pop-up").fadeOut(50);
                });

        map.events.register("moveend", map, reset);

        reset();


        function reset() {

            var bottomLeft = project(bounds[0]),
                    topRight = project(bounds[1]);

            svg.attr("width", topRight[0] - bottomLeft[0])
                    .attr("height", bottomLeft[1] - topRight[1])
                    .style("margin-left", bottomLeft[0] + "px")
                    .style("margin-top", topRight[1] + "px");

            g.attr("transform", "translate(" + -bottomLeft[0] + "," + -topRight[1] + ")");

            feature.attr("d", path);
        }

        function project(x) {
            var point = ol.proj.transform([x[0], x[1]], "EPSG:4326", "EPSG:900913");
            return [point.x, point.y];
        }
    });




</script>
</body>
</html>